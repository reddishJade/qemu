“TB的链接”（TB代表Translation Block，即翻译块）是QEMU中用于优化代码执行流程的一种技术。在QEMU中，TB是模拟的 Guest code 被转换成 Host code 的基本单位。每个TB包含了一段客人代码的翻译，这段代码可以被主机CPU执行。TB的链接目的是为了减少从静态代码（QEMU的C代码）到代码缓存（包含已翻译的TB）之间的跳转次数，从而提高执行效率。

以下是“TB的链接”的详细解释：

1. **TB执行和返回**：
   - 当一个TB执行完毕后，控制权会返回到QEMU的静态代码中。
   - 如果没有TB链接，每次TB执行完毕后都需要回到QEMU的静态代码中，然后再次跳入代码缓存去执行下一个TB。

2. **TB链接的目的**：
   - 为了减少从静态代码到代码缓存的频繁跳转，QEMU实现了TB链接。
   - 通过TB链接，当一个TB执行完毕后，可以直接跳到下一个TB，而不需要回到静态代码中。

3. **链接过程**：
   - 当TB1执行完毕后，如果没有设置链接，它会返回到静态代码中。
   - 静态代码会查找下一个TB（假设为TB2），生成该TB的主机代码，并执行TB2。
   - 在TB2执行完毕后，它会立即链接到TB1，这意味着下一次TB1执行完毕后，可以直接跳到TB2执行，而不需要再次通过静态代码。

4. **提高效率**：
   - 通过这种方式，QEMU可以减少对静态代码的依赖，减少跳转次数，提高代码执行的连续性和效率。
   - 这种链接机制也减少了查找下一个TB所需的时间，因为下一个TB已经被预先确定并链接好了。

5. **图示说明**：
   - 当 TB 执行完返回到静态代码时,静态代码会找到下一个 TB,生成它并执行。
   - 当下一个 TB 执行完返回时,它会被链接到前一个 TB。
   - 之后当前一个 TB 再次执行时,它会直接跳转到下一个 TB,而不需要返回到静态代码。

![[Qemu-detail-study_05.png]]

总结来说，“TB的链接”是QEMU中用于优化代码执行流程的技术，通过预先确定并链接后续的TB，减少了从静态代码到代码缓存的跳转次数，提高了代码执行的效率和连续性。
